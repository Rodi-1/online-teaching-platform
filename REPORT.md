# Отчёт по практической работе
## Микросервисная архитектура — "Система онлайн-преподавания"

---

## 1. Введение

В рамках практической работы по дисциплине **"Микросервисная архитектура"** была реализована платформа для онлайн-обучения, построенная по принципам микросервисной архитектуры.

**Цель работы:** Спроектировать и реализовать систему онлайн-преподавания, состоящую из независимых микросервисов, взаимодействующих друг с другом через REST API.

---

## 2. Технологический стек

### Backend
| Технология | Назначение |
|------------|------------|
| **Python 3.11+** | Основной язык разработки |
| **FastAPI** | Веб-фреймворк для создания REST API |
| **SQLAlchemy 2.0** | ORM для работы с базой данных |
| **Pydantic** | Валидация и сериализация данных |
| **JWT** | Аутентификация и авторизация |
| **bcrypt** | Хеширование паролей |

### База данных
| Технология | Назначение |
|------------|------------|
| **PostgreSQL 15** | Основная СУБД |

### Инфраструктура
| Технология | Назначение |
|------------|------------|
| **Docker** | Контейнеризация сервисов |
| **Docker Compose** | Оркестрация контейнеров |
| **Nginx** | API Gateway / Reverse Proxy |

### Тестирование
| Технология | Назначение |
|------------|------------|
| **pytest** | Фреймворк для тестирования |
| **httpx** | HTTP-клиент для тестов API |

---

## 3. Архитектура системы

### 3.1 Общая схема

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              КЛИЕНТЫ                                    │
│                    (Web-браузер, Мобильное приложение)                  │
└─────────────────────────────┬───────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         API GATEWAY (Nginx)                             │
│                           Порт: 80                                      │
└─────────────────────────────┬───────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│ User Service  │    │   Homework    │    │  Gradebook    │
│   :8001       │    │   Service     │    │   Service     │
│               │    │    :8002      │    │    :8003      │
└───────┬───────┘    └───────┬───────┘    └───────┬───────┘
        │                    │                    │
        ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                         PostgreSQL                                      │
│                         Порт: 5432                                      │
│   ┌──────────────┬──────────────┬──────────────┬──────────────┐        │
│   │user_service  │homework_     │gradebook_    │profile_      │        │
│   │_db           │service_db    │service_db    │service_db    │        │
│   └──────────────┴──────────────┴──────────────┴──────────────┘        │
│   ┌──────────────┬──────────────┬──────────────┬──────────────┐        │
│   │notifications_│tests_        │schedule_     │reports_      │        │
│   │service_db    │service_db    │service_db    │service_db    │        │
│   └──────────────┴──────────────┴──────────────┴──────────────┘        │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Слоистая архитектура каждого микросервиса

```
┌─────────────────────────────────────┐
│         API Layer (Routers)         │  ← HTTP endpoints
├─────────────────────────────────────┤
│        Service Layer (Logic)        │  ← Бизнес-логика
├─────────────────────────────────────┤
│      Repository Layer (Data)        │  ← Доступ к данным
├─────────────────────────────────────┤
│         Database (PostgreSQL)       │  ← Хранение данных
└─────────────────────────────────────┘
```

---

## 4. Реализованные микросервисы

Всего реализовано **8 микросервисов**, каждый из которых отвечает за свою доменную область.

### 4.1 User Service (Сервис пользователей)

**Порт:** 8001  
**База данных:** user_service_db

**Назначение:** Управление пользователями и аутентификация

**Функциональность:**
- Регистрация пользователей (студенты, преподаватели, администраторы)
- Аутентификация с JWT токенами
- Управление профилем пользователя
- Подтверждение email и телефона
- Восстановление пароля
- Административные функции

**API Endpoints:**
| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/auth/login` | Вход в систему |
| POST | `/api/auth/logout` | Выход из системы |
| POST | `/api/users` | Регистрация пользователя |
| GET | `/api/users/me` | Получить текущего пользователя |
| PATCH | `/api/users/me` | Обновить профиль |
| POST | `/api/users/confirm-email` | Подтвердить email |
| POST | `/api/users/confirm-phone` | Подтвердить телефон |
| POST | `/api/users:request-password-reset` | Запросить сброс пароля |
| POST | `/api/users:reset-password` | Сбросить пароль |
| GET | `/api/users` | Список пользователей (админ) |

---

### 4.2 Homework Service (Сервис домашних заданий)

**Порт:** 8002  
**База данных:** homework_service_db

**Назначение:** Управление домашними заданиями

**Функциональность:**
- Создание домашних заданий преподавателями
- Управление статусами ДЗ (draft/assigned/closed)
- Отправка решений студентами
- Просмотр решений с контролем доступа
- Выставление оценок преподавателями
- Интеграция с Gradebook Service

**API Endpoints:**
| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/courses/{course_id}/homeworks` | Создать ДЗ |
| GET | `/api/courses/{course_id}/homeworks` | Список ДЗ по курсу |
| GET | `/api/students/me/homeworks` | Мои домашние задания |
| POST | `/api/homeworks/{homework_id}/submissions` | Отправить решение |
| GET | `/api/homeworks/{homework_id}/submissions/{id}` | Просмотр решения |
| POST | `/api/homeworks/{homework_id}/submissions/{id}:grade` | Выставить оценку |

---

### 4.3 Gradebook Service (Сервис электронного журнала)

**Порт:** 8003  
**База данных:** gradebook_service_db

**Назначение:** Электронный журнал и оценки

**Функциональность:**
- Запись оценок за домашние задания и тесты
- Просмотр оценок студента с фильтрами
- Журнал по курсу для преподавателей
- Автоматический расчёт процентов и оценок (5-балльная система)

**API Endpoints:**
| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/gradebook/homework` | Записать оценку за ДЗ |
| POST | `/api/gradebook/tests` | Записать оценку за тест |
| GET | `/api/students/{student_id}/grades` | Оценки студента |
| GET | `/api/courses/{course_id}/gradebook` | Журнал курса |

---

### 4.4 Profile Service (Сервис профилей)

**Порт:** 8004  
**База данных:** profile_service_db

**Назначение:** Профили и достижения пользователей

**Функциональность:**
- Хранение и выдача профиля пользователя (аватар, описание, ссылки)
- Хранение и выдача достижений (ачивок)
- Обновление базовой статистики прогресса

**API Endpoints:**
| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/profile/me` | Получить свой профиль |
| PATCH | `/api/profile/me` | Обновить профиль |
| GET | `/api/profile/users/{user_id}/achievements` | Достижения пользователя |
| POST | `/api/profile/users/{user_id}/achievements` | Выдать достижение |
| POST | `/api/profile/users/{user_id}/stats:update` | Обновить статистику |

---

### 4.5 Notifications Service (Сервис уведомлений)

**Порт:** 8005  
**База данных:** notifications_service_db

**Назначение:** Система уведомлений

**Функциональность:**
- Хранение уведомлений для пользователей
- Получение списка уведомлений
- Пометка уведомлений как прочитанных
- Подсчёт непрочитанных уведомлений
- Приём запросов от других сервисов

**Типы уведомлений:** homework, test, schedule, achievement, system

**API Endpoints:**
| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | `/api/notifications/me` | Мои уведомления |
| POST | `/api/notifications/{id}/read` | Отметить прочитанным |
| POST | `/api/notifications:mark-all-read` | Прочитать все |
| GET | `/api/notifications/me/unread-count` | Количество непрочитанных |
| POST | `/api/notifications` | Создать уведомление |

---

### 4.6 Tests Service (Сервис тестов)

**Порт:** 8006  
**База данных:** tests_service_db

**Назначение:** Тесты и экзамены

**Функциональность:**
- Создание и публикация тестов преподавателями
- Хранение структуры теста и вопросов
- Старт попытки прохождения теста
- Приём и автопроверка ответов
- Хранение результатов попыток

**Типы вопросов:** single_choice, multiple_choice, text, number

**API Endpoints:**
| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/courses/{course_id}/tests` | Создать тест |
| POST | `/api/tests/{test_id}:publish` | Опубликовать тест |
| POST | `/api/tests/{test_id}/attempts:start` | Начать попытку |
| POST | `/api/tests/{test_id}/attempts/{id}/submit` | Отправить ответы |
| GET | `/api/tests/{test_id}/attempts/{id}` | Результат попытки |
| GET | `/api/tests/{test_id}/attempts` | Список попыток |

---

### 4.7 Schedule Service (Сервис расписания)

**Порт:** 8007  
**База данных:** schedule_service_db

**Назначение:** Расписание занятий

**Функциональность:**
- Хранение и управление занятиями (уроками)
- Выдача расписания для пользователя
- Выдача расписания по курсу
- Фиксация и просмотр посещаемости

**API Endpoints:**
| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/courses/{course_id}/lessons` | Создать занятие |
| PATCH | `/api/lessons/{lesson_id}` | Изменить занятие |
| GET | `/api/lessons/{lesson_id}` | Информация о занятии |
| GET | `/api/schedule/me` | Моё расписание |
| GET | `/api/courses/{course_id}/schedule` | Расписание курса |
| POST | `/api/lessons/{lesson_id}/attendance` | Отметить посещаемость |
| GET | `/api/lessons/{lesson_id}/attendance` | Посещаемость занятия |

---

### 4.8 Reports Service (Сервис отчётов)

**Порт:** 8008  
**База данных:** reports_service_db

**Назначение:** Отчёты и аналитика

**Функциональность:**
- Генерация отчётов (асинхронно)
- Хранение метаданных операций
- Хранение готовых отчётов
- Получение ссылок для скачивания
- Перегенерация отчётов

**Типы отчётов:** course_performance, student_progress, attendance  
**Форматы:** PDF, XLSX

**API Endpoints:**
| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | `/api/reports:generate` | Запустить генерацию |
| GET | `/api/reports/operations/{id}` | Статус операции |
| GET | `/api/reports` | Список отчётов |
| GET | `/api/reports/{id}` | Информация об отчёте |
| GET | `/api/reports/{id}/download` | Ссылка для скачивания |
| POST | `/api/reports/{id}:regenerate` | Перегенерировать |

---

## 5. Структура проекта

```
online-teaching-platform/
├── services/                          # Все микросервисы
│   ├── user-service/                  # Сервис пользователей
│   ├── homework-service/              # Сервис домашних заданий
│   ├── gradebook-service/             # Сервис электронного журнала
│   ├── profile-service/               # Сервис профилей
│   ├── notifications-service/         # Сервис уведомлений
│   ├── tests-service/                 # Сервис тестов
│   ├── schedule-service/              # Сервис расписания
│   └── reports-service/               # Сервис отчётов
│
├── infra/                             # Инфраструктура
│   ├── db/
│   │   └── init.sql                   # Инициализация БД
│   └── nginx/
│       └── nginx.conf                 # Конфигурация API Gateway
│
├── docker-compose.yml                 # Оркестрация контейнеров
└── README.md                          # Документация
```

### Структура каждого микросервиса:

```
service-name/
├── app/
│   ├── api/
│   │   ├── v1/
│   │   │   └── endpoints.py          # HTTP endpoints
│   │   └── dependencies.py           # Зависимости для авторизации
│   ├── core/
│   │   ├── config.py                 # Конфигурация
│   │   └── security.py               # JWT и безопасность
│   ├── db/
│   │   └── session.py                # Сессии БД
│   ├── models/
│   │   ├── db_models.py              # ORM модели
│   │   └── schemas.py                # Pydantic схемы
│   ├── repositories/
│   │   └── repo.py                   # Работа с БД
│   ├── services/
│   │   └── service.py                # Бизнес-логика
│   └── main.py                       # Точка входа FastAPI
├── tests/                            # Тесты
├── Dockerfile                        # Docker-образ
├── requirements.txt                  # Зависимости
└── README.md                         # Документация
```

---

## 6. Инфраструктура

### 6.1 Docker Compose

Все сервисы оркестрируются через Docker Compose. Конфигурация включает:

- **PostgreSQL** — общая база данных с отдельными схемами для каждого сервиса
- **8 микросервисов** — каждый в своём контейнере
- **Nginx** — API Gateway (опционально)
- **Сеть** — изолированная bridge-сеть `app-network`
- **Volumes** — постоянное хранилище для БД и отчётов

### 6.2 База данных

Для каждого микросервиса создаётся:
- Отдельная база данных
- Отдельный пользователь с ограниченными правами

| Сервис | База данных | Пользователь |
|--------|-------------|--------------|
| User Service | user_service_db | user_service |
| Homework Service | homework_service_db | homework_service |
| Gradebook Service | gradebook_service_db | gradebook_service |
| Profile Service | profile_service_db | profile_service |
| Notifications Service | notifications_service_db | notifications_service |
| Tests Service | tests_service_db | tests_service |
| Schedule Service | schedule_service_db | schedule_service |
| Reports Service | reports_service_db | reports_service |

### 6.3 API Gateway (Nginx)

Nginx выступает как единая точка входа для всех API запросов:
- Маршрутизация запросов к соответствующим сервисам
- Проксирование заголовков
- Health check endpoint

---

## 7. Безопасность

### 7.1 Аутентификация
- **JWT токены** для идентификации пользователей
- Токен передаётся в заголовке `Authorization: Bearer <token>`
- Настраиваемое время жизни токена

### 7.2 Авторизация
- **Role-Based Access Control (RBAC)**
- Роли: student, teacher, admin, manager
- Проверка прав на уровне API endpoints

### 7.3 Защита данных
- Хеширование паролей с bcrypt
- Валидация всех входных данных через Pydantic
- Защита от SQL-инъекций через SQLAlchemy ORM
- Переменные окружения для секретов

---

## 8. Тестирование

Для каждого сервиса реализованы **два вида тестов**:

### 8.1 Интеграционные тесты (Integration tests)
- Тестирование API endpoints через HTTP-запросы
- Используют TestClient (FastAPI) и SQLite in-memory
- Проверяют полный цикл: запрос → бизнес-логика → БД → ответ

### 8.2 Unit-тесты
- Тестирование бизнес-логики изолированно
- Используют моки (Mock) вместо реальных зависимостей
- Быстрое выполнение без накладных расходов на БД

### Статистика Unit-тестов:

| Сервис | Unit-тестов | Что тестируется |
|--------|-------------|-----------------|
| gradebook-service | 7 | Расчёт оценок, валидация |
| tests-service | 10 | Проверка ответов, расчёт баллов |
| schedule-service | 7 | Валидация ролей и дат |
| reports-service | 8 | Генерация путей, проверка ролей |
| notifications-service | 3 | Авторизация уведомлений |
| profile-service | 3 | Проверка дубликатов достижений |
| homework-service | 4 | Валидация оценок и дедлайнов |
| **ИТОГО** | **42** | — |

### Запуск тестов:
```powershell
# Unit-тесты для одного сервиса
cd services/gradebook-service
python -m pytest tests/unit/ -v

# Интеграционные тесты
python -m pytest tests/test_api_*.py -v

# Все тесты
python -m pytest tests/ -v
```

---

## 9. Запуск проекта

### Запуск через Docker Compose:

```bash
# Клонировать репозиторий
git clone <repository-url>
cd online-teaching-platform

# Запустить все сервисы
docker-compose up -d

# Проверить статус
docker-compose ps
```

### Доступ к сервисам:

| Сервис | URL | Документация API |
|--------|-----|------------------|
| User Service | http://localhost:8001 | http://localhost:8001/docs |
| Homework Service | http://localhost:8002 | http://localhost:8002/docs |
| Gradebook Service | http://localhost:8003 | http://localhost:8003/docs |
| Profile Service | http://localhost:8004 | http://localhost:8004/docs |
| Notifications Service | http://localhost:8005 | http://localhost:8005/docs |
| Tests Service | http://localhost:8006 | http://localhost:8006/docs |
| Schedule Service | http://localhost:8007 | http://localhost:8007/docs |
| Reports Service | http://localhost:8008 | http://localhost:8008/docs |

---

## 10. Взаимодействие между сервисами

### Схема взаимодействия:

```
┌─────────────────┐     JWT токен      ┌─────────────────┐
│  User Service   │◄──────────────────►│   Все сервисы   │
└─────────────────┘                    └─────────────────┘

┌─────────────────┐   Оценка за ДЗ     ┌─────────────────┐
│Homework Service │──────────────────►│Gradebook Service│
└─────────────────┘                    └─────────────────┘

┌─────────────────┐   Обновление       ┌─────────────────┐
│  Tests Service  │───статистики──────►│ Profile Service │
└─────────────────┘                    └─────────────────┘

┌─────────────────┐   Уведомление      ┌─────────────────┐
│   Все сервисы   │──────────────────►│Notifications    │
└─────────────────┘                    │    Service      │
                                       └─────────────────┘

┌─────────────────┐   Данные для       ┌─────────────────┐
│Gradebook/       │───отчётов─────────►│ Reports Service │
│Schedule         │                    └─────────────────┘
└─────────────────┘
```

### Примеры интеграций:
1. **Homework → Gradebook:** При выставлении оценки за ДЗ она автоматически записывается в журнал
2. **Tests → Profile:** После прохождения теста обновляется статистика в профиле
3. **Все сервисы → Notifications:** Создание уведомлений о событиях

---

## 11. CI/CD Pipeline

Проект использует **GitHub Actions** для автоматизации тестирования и деплоя.

### 11.1 Continuous Integration (CI)

Файл: `.github/workflows/ci.yml`

**Этапы CI pipeline:**

```
┌─────────────┐     ┌─────────────┐     ┌─────────────────────┐     ┌─────────────┐
│   Линтинг   │────►│ Unit-тесты  │────►│ Интеграционные тесты│────►│   Готово    │
│  (flake8)   │     │  (pytest)   │     │      (pytest)       │     │     ✅      │
└─────────────┘     └─────────────┘     └─────────────────────┘     └─────────────┘
```

| Этап | Описание | Инструменты |
|------|----------|-------------|
| **Lint** | Проверка стиля кода | flake8, black, isort |
| **Unit Tests** | Тестирование бизнес-логики | pytest + моки |
| **Integration Tests** | Тестирование API endpoints | pytest + TestClient |

**Триггеры:**
- Push в ветки `main`, `develop`
- Pull Request в ветки `main`, `develop`

### 11.2 Continuous Deployment (CD)

Файл: `.github/workflows/cd.yml`

**Этапы CD pipeline:**

```
┌─────────────────┐     ┌─────────────┐     ┌─────────────┐
│ Запуск тестов   │────►│   Сборка    │────►│   Деплой    │
│ (unit + integ)  │     │   Docker    │     │ Production  │
└─────────────────┘     └─────────────┘     └─────────────┘
```

**Триггеры:**
- Push в ветку `main`
- Ручной запуск (workflow_dispatch)

### 11.3 Запуск Pipeline

При каждом push/PR автоматически:
1. ✅ Проверяется код линтерами
2. ✅ Запускаются unit-тесты (42 теста)
3. ✅ Запускаются интеграционные тесты
4. ✅ Собираются Docker-образы
5. ✅ Выполняется деплой (при push в main)

---

## 12. Принципы микросервисной архитектуры

В проекте применены следующие принципы:

### 12.1 Декомпозиция по бизнес-функциям
Каждый сервис отвечает за свою доменную область и имеет чётко определённые границы.

### 12.2 Независимое развёртывание
Сервисы могут быть развёрнуты независимо друг от друга.

### 12.3 Изоляция данных
Каждый сервис имеет собственную базу данных.

### 12.4 API-First подход
Взаимодействие между сервисами осуществляется через REST API.

### 12.5 Контейнеризация
Каждый сервис упакован в Docker-контейнер.

### 12.6 Единая точка входа
API Gateway (Nginx) обеспечивает единую точку входа для клиентов.

---

## 13. Заключение

В результате выполнения практической работы была спроектирована и реализована микросервисная платформа для онлайн-обучения, включающая:

- ✅ **8 микросервисов** с чётко разделённой ответственностью
- ✅ **REST API** для каждого сервиса с автодокументацией (Swagger)
- ✅ **Единая база данных PostgreSQL** с изолированными схемами
- ✅ **Docker-контейнеризация** всех компонентов
- ✅ **Docker Compose** для оркестрации
- ✅ **API Gateway** на базе Nginx
- ✅ **JWT-аутентификация** и RBAC-авторизация
- ✅ **Два вида тестов**: Unit-тесты (42 шт.) и Интеграционные тесты
- ✅ **CI/CD Pipeline** с автоматическим запуском тестов
- ✅ **Layered Architecture** в каждом сервисе

Проект демонстрирует применение принципов микросервисной архитектуры и готов к дальнейшему развитию и масштабированию.

---

*Дата выполнения: Декабрь 2025*  
*Дисциплина: Микросервисная архитектура*

