name: CD - Build, Test and Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # # ============================================
  # # JOB 1: Запуск всех тестов перед деплоем
  # # ============================================
  # test-before-deploy:
  #   name: Run Tests Before Deploy
  #   runs-on: ubuntu-latest
    
  #   strategy:
  #     fail-fast: true  # Остановить если хоть один сервис падает
  #     matrix:
  #       service:
  #         - user-service
  #         - homework-service
  #         - gradebook-service
  #         - profile-service
  #         - notifications-service
  #         - tests-service
  #         - schedule-service
  #         - reports-service
    
  #   steps:
  #   - uses: actions/checkout@v3
    
  #   - name: Set up Python 3.11
  #     uses: actions/setup-python@v4
  #     with:
  #       python-version: '3.11'
    
  #   - name: Install dependencies
  #     working-directory: ./services/${{ matrix.service }}
  #     run: |
  #       python -m pip install --upgrade pip
  #       pip install -r requirements.txt
  #       pip install pytest
    
  #   - name: Run Unit Tests
  #     working-directory: ./services/${{ matrix.service }}
  #     run: |
  #       # Запускаем unit-тесты если папка существует
  #       if [ -d "tests/unit" ]; then
  #         pytest tests/unit/ -v --tb=short
  #       else
  #         echo "No unit tests found, skipping..."
  #       fi
    
  #   - name: Run Integration Tests
  #     working-directory: ./services/${{ matrix.service }}
  #     run: |
  #       pytest tests/test_api_*.py -v --tb=short

  # ============================================
  # JOB 2: Сборка и публикация Docker-образов
  # ============================================
  build-and-push:
    name: Build & Push to DockerHub - ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: test-before-deploy
    
    strategy:
      fail-fast: false
      matrix:
        service:
          - user-service
          - gradebook-service
          - notifications-service
          - schedule-service
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and push image
      uses: docker/build-push-action@v5
      with:
        context: ./services/${{ matrix.service }}
        file: ./services/${{ matrix.service }}/Dockerfile
        push: true
        platforms: linux/amd64
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/online-teaching-${{ matrix.service }}:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/online-teaching-${{ matrix.service }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ============================================
  # JOB 3: Сборка и публикация в Yandex Container Registry
  # ============================================
  build-and-push-yc:
    name: Build & Push to YCR - ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: test-before-deploy
    
    strategy:
      fail-fast: false
      matrix:
        service:
          - homework-service
          - profile-service
          - tests-service
          - reports-service
    
    steps:
    - uses: actions/checkout@v3

    - name: Auth to Yandex Container Registry
    # YC_KEYS должен содержать JSON ключ сервисного аккаунта
      uses: yc-actions/yc-cr-login@v1
      with:
        yc-sa-json-credentials: ${{ secrets.YC_KEYS }}
        
    - name: Set up Docker Buildx          
      uses: docker/setup-buildx-action@v3

    - name: Build and push image to YCR
      uses: docker/build-push-action@v5
      with:
        context: ./services/${{ matrix.service }}
        file: ./services/${{ matrix.service }}/Dockerfile
        push: true
        tags: |
          cr.yandex/${{ secrets.YC_REGISTRY_ID }}/online-teaching-${{ matrix.service }}:latest
          cr.yandex/${{ secrets.YC_REGISTRY_ID }}/online-teaching-${{ matrix.service }}:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ============================================
  # JOB 4: Деплой серверлесс-контейнеров в Yandex Cloud
  # ============================================
  deploy-sls-yc:
    name: Deploy SLS Container - ${{ matrix.service }}
    runs-on: ubuntu-latest
    needs: build-and-push-yc
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - service: homework-service
            container_secret: YC_CONTAINER_HOMEWORK
          - service: profile-service
            container_secret: YC_CONTAINER_PROFILE
          - service: tests-service
            container_secret: YC_CONTAINER_TESTS
          - service: reports-service
            container_secret: YC_CONTAINER_REPORTS

    steps:
      - name: Deploy to Yandex Serverless Containers
        uses: yc-actions/yc-sls-container-deploy@v2
        with:
          # JSON-ключ сервисного аккаунта
          yc-sa-json-credentials: ${{ secrets.YC_KEYS }}

          # Папка, где создаются/обновляются контейнеры
          folder-id: ${{ secrets.FOLDER_ID }}

          # Имя serverless-контейнера (хранится в секретах)
          container-name: ${{ secrets[matrix.container_secret] }}

          # ОБЯЗАТЕЛЬНО: URL образа из YCR
          revision-image-url: cr.yandex/${{ secrets.YC_REGISTRY_ID }}/online-teaching-${{ matrix.service }}:latest

          # Сервисный аккаунт, от имени которого будет работать контейнер
          revision-service-account-id: ${{ secrets.SA_ID }}

          # Ресурсы ревизии
          revision-cores: 1
          revision-memory: 512Mb
          revision-core-fraction: 100
          revision-concurrency: 8

          # Переменные окружения приложения
          revision-env: |
            PORT=8080
            ENV=prod
            # сюда можно добавить другие переменные для сервисов


